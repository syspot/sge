<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html" xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:ts="http://java.sun.com/jsf/composite/components">

	<ui:param name="mbean" value="${agendaFaces}" />
	<ui:param name="mbeanModel" value="${agendaFaces.crudModel}" />
	<ui:param name="mbeanPesquisaModel" value="${agendaFaces.crudPesquisaModel}" />

	<h:form prependId="false">

		<h:panelGrid columns="1" style="width: 100%">

			<h:panelGrid columns="3" columnClasses="coluna5, coluna5, coluna95" style="width: 100%">
				<p:calendar value="#{mbeanPesquisaModel.dataInicial}" navigator="true" pattern="dd/MM/yyyy" size="10" required="true" requiredMessage="Preencha a data para pesquisar."/>
				<p:commandButton icon="ui-icon-search" value="Pesquisar" action="#{mbean.pesquisarBaseadoEquipamentos}" update="gridAgenda" />
				<p:commandButton icon="ui-icon-disk" action="#{mbean.salvarAlteracoes}" value="Salvar Alterações" update="@form" />
			</h:panelGrid>

			<p:scrollPanel mode="native" style="width: 99.5%; height: 300px">

				<p:dataTable rowStyleClass="#{linha==mbean.agendaSelecionada?laranja:null}" style="width: 99%" id="gridAgenda" value="#{mbean.grid}" var="linha" emptyMessage="Nenhum registro encontrado" rowIndexVar="i">

					<p:column headerText="Equipamento" styleClass="coluna30">
						<h:selectOneMenu value="#{linha.equipamento.id}" style="width:99%;padding: 3px">
							<f:selectItem itemLabel="Não Selecionado" itemValue="" />
							<f:selectItems value="#{mbean.comboEquipamentosPesquisa}" />
						</h:selectOneMenu>
					</p:column>

					<p:column headerText="Tipo" styleClass="coluna10">
						<h:selectOneMenu value="#{linha.tipoServico.id}" style="width:99%;padding: 3px">
							<f:selectItem itemLabel="Não Selecionado" itemValue="" />
							<f:selectItems value="#{mbean.comboTiposServicos}" />
						</h:selectOneMenu>
					</p:column>

					<p:column headerText="Cliente" styleClass="coluna20">
						<h:selectOneMenu id="cliente" value="#{linha.contrato.cliente.id}" style="width:99%;padding: 3px">
							<f:selectItem itemLabel="Não Selecionado" itemValue="" />
							<f:selectItems value="#{mbean.comboClientes}" />
							<p:ajax event="change" listener="#{mbean.atualizarContratos(linha.contrato)}" update="teste2" />
						</h:selectOneMenu>
					</p:column>

					<p:column headerText="Contrato" styleClass="coluna20">
						<p:outputPanel id="teste2" layout="block" autoUpdate="true">
							<h:selectOneMenu id="contrato" value="#{linha.contrato.id}" style="width:99%;padding: 3px">
								<f:selectItem itemLabel="Não Selecionado" itemValue="" />
								<f:selectItems value="#{linha.contrato.cliente.contratos}" var="i" itemLabel="#{i.descricao}" itemValue="#{i.id}" />
							</h:selectOneMenu>
						</p:outputPanel>
					</p:column>

					<p:column styleClass="coluna3">
						<div align="center">
							<p:commandLink id="clSelecionar" update="gridAgenda">
								<h:graphicImage value="../resources/images/lupa.png" style="border: 0px;width: 16px; height: 16px" />
								<f:setPropertyActionListener target="#{mbean.crudModel}" value="#{linha}" />
							</p:commandLink>
						</div>
					</p:column>

				</p:dataTable>

			</p:scrollPanel>

			<p:outputPanel id="opMedicao" layout="block" autoUpdate="true">

				<p:panel id="fsMedicao" header="Medições" style="width: 99%">

					<h:panelGrid columns="1">

						<p:commandButton id="btnReferencia" value="Adicionar Medição" icon="ui-icon-plus" action="#{mbean.addMedicao}" update="gridMedicao" />

						<p:dataTable id="gridMedicao" value="#{mbean.crudModel.medicoes}" var="linha" style="width: 100%" emptyMessage="Não existe lançamento de medição" paginator="true" rows="3" paginatorAlwaysVisible="false" rowIndexVar="i">

							<p:column headerText="#">
        					#{i+1}
    					</p:column>

							<p:column headerText="Código" styleClass="coluna5">
								<div align="center">
									<h:outputText value="#{linha.id}" />
								</div>
							</p:column>

							<p:column headerText="Data Inicial" styleClass="coluna15">
								<p:calendar value="#{linha.dataInicial}" navigator="true" pattern="dd/MM/yyyy HH:mm" size="15" required="true" requiredMessage="Data Inicial Medição #{i}: Campo obrigatório">
									<p:ajax event="change" listener="#{agendaFaces.atualizarValorMedicao(linha)}" update="teste" global="false" />
								</p:calendar>
							</p:column>

							<p:column headerText="Data Final" styleClass="coluna15">

								<p:calendar value="#{linha.dataFinal}" navigator="true" pattern="dd/MM/yyyy HH:mm" size="15" required="true" requiredMessage="Data Final Medição #{i}: Campo obrigatório">
									<p:ajax event="change" listener="#{agendaFaces.atualizarValorMedicao(linha)}" update="teste" global="false" />
								</p:calendar>

							</p:column>

							<p:column headerText="Operador" styleClass="coluna25">
								<p:selectOneMenu id="operadorMedicao" value="#{linha.operadorTemp.id}" required="true" requiredMessage="Operador Medição #{i}: Campo obrigatório" style="width:98%">
									<f:selectItem itemLabel="Não Selecionado" itemValue="" />
									<f:selectItems value="#{agendaFaces.comboOperadoresPesquisa}" />
								</p:selectOneMenu>
							</p:column>

							<p:column headerText="Obs." styleClass="coluna25">
								<p:inputTextarea rows="2" value="#{linha.observacao}" style="width: 95%" autoResize="false" />
							</p:column>

							<p:column id="colValor#{i}" headerText="Valor" styleClass="coluna15">
								<p:outputPanel id="teste" layout="block" autoUpdate="true">
									<p:inputText id="valorMedicao#{i}" style="width: 90%; text-align: right" value="#{linha.valor}" onkeyup="return mascaraMoeda(this)" required="true" requiredMessage="Valor Medição #{i}: Campo obrigatório">
										<f:convertNumber type="number" pattern="#,###,##0.##" locale="pt_BR" minFractionDigits="2" maxFractionDigits="2" />
									</p:inputText>
								</p:outputPanel>
							</p:column>

							<p:column headerText="Excluir" styleClass="coluna5">

								<div align="center">

									<p:commandLink action="#{agendaFaces.excluirMedicao}" icon="delete16" id="clExcluir" process="@this" update=":formDialog:fsMedicao gridMedicao" global="false">

										<h:graphicImage value="../resources/images/delete16.png" style="border: 0px" />
										<f:setPropertyActionListener target="#{agendaFaces.medicaoSelecionada}" value="#{linha}" />

									</p:commandLink>

								</div>

							</p:column>

						</p:dataTable>

					</h:panelGrid>

				</p:panel>

			</p:outputPanel>

		</h:panelGrid>

	</h:form>

</ui:composition>